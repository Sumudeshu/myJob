<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GET Request Example</title>
<style>
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
<button onclick="makeGetRequest()">get all students</button>
<input type="text" name="id_search" id="id_search" placeholder="id">
<button onclick="makeGetRequestById()">search student</button>
<div id="myTable" class="hidden">
    <table id="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
          </tr>
        </thead>
        <tbody id="stuBody">
          <!-- 数据将被动态插入到这里 -->
        </tbody>
    </table>
</div>
<button onclick="add()">add student</button>
<form id="addStudent" class="hidden">
    编号：
    <input type="text" name="id" id="id">
    <br> 姓名：
    <input type="text" name="name" id="name">
    <input type="button" value="submit" onclick="makePostRequest()">
</form>


<script>
    function makeGetRequest() {
        fetch("http://localhost:8080/test2")
            .then(response => response.json())
            .then(data => jsonToTable(data))
            .catch(error => console.error('Error:', error));
    }

    function makeGetRequestById() {
        var id = document.getElementById('id_search').value;;
 
        fetch(`http://localhost:8080/search/${id}`)
        .then(response => response.json())
        .then(data => {
            // 配列に変更する
            let arr = [];
            arr[0] = data;
            jsonToTable(arr);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function jsonToTable(jsonData) {
        var div = document.getElementById('myTable');
        div.classList.remove('hidden'); // 移除hidden类，显示div
        var tr = document.getElementById("stuBody");
            var str = ``;
            for (var i = 0; i < jsonData.length; i++) {
                var obj = jsonData[i];
                str += `<tr>
                    <td>${obj.id}</td>
                    <td>${obj.name}</td>
                    <td>
                        <input type="button" class='data delete' value="delete">
                        <input type="button" class='data update' value="update">
                        <input type="button" class='data confirmData hidden' value="submit">
                    </td>
                </tr>`;
            }
        tr.innerHTML = str;
        const deletes = document.getElementsByClassName('delete');
        for (let i = 0; i < deletes.length; i++) {
            deletes[i].addEventListener('click', function() {
                const tr = deletes[i].parentNode.parentNode;
                const tdId = tr.firstElementChild;
                const id = tdId.textContent;
                del(id);
            });
        }
        const updates = document.getElementsByClassName('update');
        for (let i = 0; i < updates.length; i++) {
            updates[i].addEventListener('click', function() {
                const tr = updates[i].parentNode.parentNode;
                const tdId = tr.firstElementChild;
                const tdName = tr.getElementsByTagName('td')[1];
                const id = tdId.textContent;
                let name = tdName.textContent;
                // tdId.innerHTML = `<input type="text" placeholder=${id}>`;
                tdName.innerHTML = `<input type="text" placeholder=${name}>`;
                // 隐藏前两个按钮，打开第3个按钮
                const inputs = tr.getElementsByClassName('data');
                for (let j = 0; j < inputs.length - 1; j++) {
                    inputs[j].classList.add("hidden");
                }
                const confirmButton = inputs[2];
                confirmButton.classList.remove('hidden');
                confirmButton.addEventListener('click', function() {
                    update(this);
                });
            });
        }
    } 

    function add() {
        var div = document.getElementById('addStudent');
        div.classList.remove('hidden'); // 移除hidden类，显示div
    }
    
    function makePostRequest() {
        //获取表单输入框数据
        let id = document.getElementById('id').value;
        let name = document.getElementById('name').value;
        var url = "http://localhost:8080/create";
        var data = {
            id: id,
            name: name
        };

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(json => {
            console.log(json);
            alert("add student success")
        })
        .catch(error => console.error('Error:', error));
    }

    // 删除
    function del(id) {
        fetch(`http://localhost:8080/deleteStudentById/${id}`, {method: "DELETE"})
        .then(response => response.json())
        .then(data => console.log(json))
        .catch(error => {
            console.error('Error:', error);
        });
    }
    // 修改
    function update(tdConfirmButton) {
        const tr = tdConfirmButton.parentNode.parentNode;
        const tdId = tr.firstElementChild;
        const tdName = tr.getElementsByTagName('td')[1];
        const id = tdId.textContent;
        let name = tdName.firstElementChild.value;
        var url = "http://localhost:8080/updateUserById";
        var data = {
            id: id,
            name: name
        };

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(json => {
            console.log(json);
        })
        .catch(error => console.error('Error:', error));
    }
</script>
</body>
</html>